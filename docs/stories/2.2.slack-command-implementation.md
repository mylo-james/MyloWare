# Story 2.2: Slack Command Implementation

## Status

Approved

## Story

**As a** user,
**I want** to use slash commands to interact with the platform,
**so that** I can easily start workflows, check status, and communicate with the system.

## Acceptance Criteria

1. `/mylo new` command implemented with workflow template selection
2. `/mylo status` command with run_id parameter for status checking
3. `/mylo talk` command for conversational interaction
4. `/mylo stop` and `/mylo mute` commands for workflow control
5. Command signature verification and error handling

## Tasks / Subtasks

- [ ] Task 1: Implement `/mylo new` Command (AC: 1)
  - [ ] Create slash command handler for workflow creation
  - [ ] Parse optional template parameter and title flag
  - [ ] Integrate with workflow-service to start new workflows
  - [ ] Return ephemeral response with run_id and thread link
  - [ ] Seed thread in #mylo-feed channel with initial status

- [ ] Task 2: Implement `/mylo status` Command (AC: 2)
  - [ ] Create slash command handler for status checking
  - [ ] Parse run_id parameter with validation
  - [ ] Query workflow-service for current status
  - [ ] Return ephemeral status snapshot to user
  - [ ] Post threaded update in #mylo-feed channel

- [ ] Task 3: Implement `/mylo talk` Command (AC: 3)
  - [ ] Create slash command handler for user comments
  - [ ] Parse message content and validate
  - [ ] Add user comment to appropriate run thread
  - [ ] Route message to workflow orchestrator for context
  - [ ] Acknowledge receipt with ephemeral response

- [ ] Task 4: Implement `/mylo stop` and `/mylo mute` Commands (AC: 4)
  - [ ] Create slash command handler for `/mylo stop`
  - [ ] Integrate with workflow-service to cancel runs
  - [ ] Create slash command handler for `/mylo mute`
  - [ ] Implement user-specific notification suppression
  - [ ] Return confirmation responses for both commands

- [ ] Task 5: Command Signature Verification (AC: 5)
  - [ ] Implement Slack request signature verification
  - [ ] Use SLACK_SIGNING_SECRET for signature validation
  - [ ] Reject requests with 400 if verification fails
  - [ ] Log security events for failed verifications
  - [ ] Never process payloads before verification

- [ ] Task 6: Error Handling and Logging (AC: 5)
  - [ ] Implement ephemeral error responses for user issues
  - [ ] Handle invalid run_id, unknown template errors
  - [ ] Add correlation logging with request_id, user_id, run_id
  - [ ] Implement graceful fallback for service unavailability
  - [ ] Test error scenarios and edge cases

- [ ] Task 7: Integration Testing (All ACs)
  - [ ] Test all slash commands end-to-end
  - [ ] Test command parameter parsing and validation
  - [ ] Test signature verification with valid/invalid requests
  - [ ] Test error handling and fallback scenarios
  - [ ] Test integration with workflow-service and threading
  - [ ] Verify `WORKFLOW_SERVICE_URL` present in `.env.example`

## Dev Notes

### Previous Story Insights

This story builds on the Slack app configuration from Story 2.1. The `notification-service` has the `SlackService` foundation, and this story adds slash command handling capabilities on top of the existing Socket Mode connection.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**WorkOrder Entity:**

- Primary entity for tracking workflow runs started via `/mylo new`
- `id`: UUID used as run_id in commands
- `status`: WorkOrderStatus for status checking
- `workflow_id`: Temporal workflow identifier
- `metadata`: JSON for storing command context and user info

**No additional data models needed** - commands primarily interact with existing workflow and notification services.

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Slash Commands:**

- Commands sent as POST requests to configured endpoints
- Request signature verification using SLACK_SIGNING_SECRET
- Response formats: ephemeral messages, channel messages, threaded replies

**Internal Service Integration:**

- `workflow-service` API for starting/stopping workflows
- `workflow-service` API for status queries
- Thread management through `SlackService.sendMessage` with `thread_ts`

### Component Specifications

**Slash Command Handler Architecture:**

- Command routing and parameter parsing
- Service integration layer
- Response formatting and error handling
- Signature verification middleware

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Notification Service Extensions:**

- `packages/notification-service/src/controllers/slack-commands.controller.ts` - New slash command endpoints
- `packages/notification-service/src/services/slack-command.service.ts` - Command processing logic
- `packages/notification-service/src/middleware/slack-verification.middleware.ts` - Signature verification
- `packages/notification-service/src/services/slack.service.ts` - Extended for command responses

**Integration Points:**

- `packages/workflow-service/src/controllers/workflow.controller.ts` - Workflow management APIs
- `packages/notification-service/src/services/thread-manager.service.ts` - Thread management

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Tests:**

- Test each slash command handler individually
- Test command parameter parsing and validation
- Test signature verification logic
- Test error handling and edge cases
- Mock all external service calls

**Integration Tests:**

- Test complete slash command workflows
- Test signature verification with real/simulated Slack requests
- Test integration with workflow-service
- Test threading and channel management
- Test error scenarios and fallback handling

**Test Files:**

- `packages/notification-service/test/slack-commands.controller.test.ts`
- `packages/notification-service/test/slack-command.service.test.ts`
- `packages/notification-service/test/slack-verification.middleware.test.ts`

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Slack SDK:** @slack/bolt 3.17.0 for slash command handling
**Framework:** NestJS 10.3.2 with controller and middleware patterns
**Validation:** Joi 17.11.0 for command parameter validation
**HTTP Client:** Axios 1.6.0 for workflow-service integration
**Logging:** Winston 3.11.0 with correlation IDs

### Command Specifications

**Command Catalog (MVP):**

1. **`/mylo new [template] [--title "..."]`**
   - Starts workflow with optional template
   - Returns ephemeral response with run_id and link
   - Seeds thread in #mylo-feed with initial status
   - Example: `/mylo new docs-extract --title "Process invoices"`

2. **`/mylo status <run_id>`**
   - Returns ephemeral status snapshot
   - Posts threaded update in #mylo-feed
   - Example: `/mylo status 12345678-1234-1234-1234-123456789012`

3. **`/mylo talk <message>`**
   - Adds user comment to run thread
   - Routes to orchestrator for context
   - Example: `/mylo talk Please prioritize the urgent invoices`

4. **`/mylo stop <run_id>`**
   - Cancels run if permissible
   - Returns confirmation or error message
   - Example: `/mylo stop 12345678-1234-1234-1234-123456789012`

5. **`/mylo mute <run_id>`**
   - Suppresses non-critical updates for requester
   - User-specific notification preferences
   - Example: `/mylo mute 12345678-1234-1234-1234-123456789012`

### Request Verification Implementation

**Signature Verification Process:**

1. Extract timestamp and signature from Slack headers
2. Construct basestring from timestamp and raw request body
3. Compute HMAC-SHA256 using SLACK_SIGNING_SECRET
4. Compare computed signature with provided signature
5. Reject with 400 if verification fails
6. Check timestamp freshness (< 5 minutes old)

### Error Handling Strategy

**User-Facing Errors (Ephemeral Responses):**

- Invalid run_id format or not found
- Unknown template names
- Insufficient permissions
- Service temporarily unavailable

**System Errors (Logged):**

- Signature verification failures
- Service integration failures
- Unexpected exceptions
- Rate limiting issues

### Integration Points

**With Previous Stories:**

- Uses Slack app configuration from Story 2.1
- Leverages Socket Mode connection and bot permissions
- Uses established channel structure (#mylo-feed, #mylo-control)

**With Future Stories:**

- Provides command foundation for approval workflows (Story 2.3)
- Integrates with policy engine for permission checks (Story 2.4)
- Uses threading strategy from channel management (Story 2.5)

**With Workflow Service:**

- `POST /workflows/start` - Start new workflows
- `GET /workflows/{id}/status` - Get workflow status
- `POST /workflows/{id}/stop` - Stop workflows
- `POST /workflows/{id}/comment` - Add user comments

### Environment Variables Required

From `.env.example` [Source: .env.example]:

- `SLACK_BOT_TOKEN` - For sending command responses
- `SLACK_SIGNING_SECRET` - For request signature verification
- `WORKFLOW_SERVICE_URL` - For workflow integration
- `NOTIFICATION_SERVICE_PORT` - Service configuration

### Testing

Based on architecture test strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Test Requirements:**

- Test command parsing with various parameter combinations
- Test signature verification with valid/invalid signatures
- Test error handling for all command types
- Test response formatting for ephemeral and channel messages
- Mock workflow-service responses and test integration logic

**Integration Test Requirements:**

- Test complete slash command workflows using simulation mode
- Test signature verification with real Slack request format
- Test threading and channel posting functionality
- Test error scenarios and service unavailability
- Test rate limiting and timeout handling

**Test Coverage Target:** 80% for command handling logic

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be populated by Dev agent_

## QA Results

**Review Date:** 2025-08-18  
**Reviewer:** QA.mdc  
**Overall Status:** FAIL (implementation scaffolding missing; env config incomplete)

### Acceptance Criteria Validation

| AC  | Requirement                                       | Status | Evidence / Notes                                                                            |
| --- | ------------------------------------------------- | ------ | ------------------------------------------------------------------------------------------- |
| 1   | `/mylo new` with template selection               | FAIL   | No controller/service exists for slash commands. Files referenced in story are not present. |
| 2   | `/mylo status <run_id>`                           | FAIL   | No implementation or tests found.                                                           |
| 3   | `/mylo talk <message>`                            | FAIL   | No implementation or tests found.                                                           |
| 4   | `/mylo stop`, `/mylo mute`                        | FAIL   | No implementation or tests found.                                                           |
| 5   | Command signature verification and error handling | FAIL   | No verification middleware/logic found.                                                     |

### Repository Cross-Check

- Missing files referenced by story:
  - `packages/notification-service/src/controllers/slack-commands.controller.ts` (not found)
  - `packages/notification-service/src/services/slack-command.service.ts` (not found)
  - `packages/notification-service/src/middleware/slack-verification.middleware.ts` (not found)

- Tests referenced by story are missing:
  - `packages/notification-service/test/slack-commands.controller.test.ts` (not found)
  - `packages/notification-service/test/slack-command.service.test.ts` (not found)
  - `packages/notification-service/test/slack-verification.middleware.test.ts` (not found)

- Env variables:
  - `.env.example` does not contain `WORKFLOW_SERVICE_URL`, but story requires it. Present only in `docs/phase-2-human-tasks.md` as a note. Add to `.env.example`.

- Dependent service endpoints:
  - `workflow-service` exposes endpoints under `/workflows` (e.g., `POST /workflows/docs-extract-verify`, `GET /workflows/:id/status`, `DELETE /workflows/:id`). Map command actions accordingly.

### Blocking Gaps

- No command handling pipeline exists (router, verification, service integration).
- Socket Mode is not started; even with handlers, events would not be received.
- Missing `WORKFLOW_SERVICE_URL` in environment template.

### Recommendations (P0 = immediate)

- P0: Add the following components in `notification-service`:
  - `controllers/slack-commands.controller.ts` with routes for slash commands (respecting global prefix `api/v1`).
  - `middleware/slack-verification.middleware.ts` implementing signature verification per Slack spec.
  - `services/slack-command.service.ts` encapsulating parsing, validation, and workflow-service integration.
- P0: Update `.env.example` to include `WORKFLOW_SERVICE_URL=http://localhost:3001`.
- P0: Start Bolt `App` in `SlackService` when `appToken` is present to enable Socket Mode events for command interactions.
- P1: Implement the unit and integration tests listed in the story using simulation mode for Slack.

### Evidence

- Grep confirms referenced files do not exist; see repository search results.
- `.env.example` currently includes `SLACK_BOT_TOKEN`, `SLACK_SIGNING_SECRET`, `SLACK_APP_TOKEN` but not `WORKFLOW_SERVICE_URL`.
- `packages/workflow-service/src/controllers/workflow.controller.ts` exposes start/status/stop-like endpoints for integration.
