# Story 2.3: Approval Card System

## Status

Approved

## Story

**As an** approver,
**I want** interactive approval cards for human-in-the-loop decisions,
**so that** I can review and approve or deny automated actions that require human oversight.

## Acceptance Criteria

1. Approval card generation with context and decision options
2. Interactive buttons for approve, deny, skip, and abort actions
3. Approval event recording in database with audit trail
4. Soft gate timeout handling with auto-approval
5. Hard gate blocking until human decision

## Tasks / Subtasks

- [ ] Task 1: Implement Approval Card Generation (AC: 1)
  - [ ] Create Block Kit card template with context sections
  - [ ] Include run_id, action description, requester info, priority
  - [ ] Add contextual metadata and reasoning for approval request
  - [ ] Format card with consistent styling and branding
  - [ ] Support different approval types (deployment, data access, etc.)

- [ ] Task 2: Implement Interactive Button Actions (AC: 2)
  - [ ] Create buttons for Approve, Deny, Skip, and Abort actions
  - [ ] Implement button callback handling and routing
  - [ ] Parse button interaction payloads and extract approval_id
  - [ ] Add button styling (primary for approve, danger for deny)
  - [ ] Handle button state updates and disable after decision

- [ ] Task 3: Approval Event Database Recording (AC: 3)
  - [ ] Integrate with policy-service for approval creation
  - [ ] Record approval decisions with approver, timestamp, reason
  - [ ] Implement audit trail with full decision history
  - [ ] Store approval context and metadata for compliance
  - [ ] Support approval event querying and reporting

- [ ] Task 4: Soft Gate Timeout Handling (AC: 4)
  - [ ] Implement configurable timeout for soft gates (default 24h)
  - [ ] Create background job for timeout processing
  - [ ] Auto-approve on timeout with notification to #mylo-approvals
  - [ ] Update approval card with timeout status and timestamp
  - [ ] Log timeout events for audit and monitoring

- [ ] Task 5: Hard Gate Blocking Implementation (AC: 5)
  - [ ] Implement hard gate that blocks until human decision
  - [ ] No timeout or auto-approval for hard gates
  - [ ] Escalation notifications for overdue hard gates
  - [ ] Admin override capabilities for emergency situations
  - [ ] Clear visual distinction between soft and hard gates

- [ ] Task 6: Approval Card UI/UX Polish (AC: 1, 2)
  - [ ] Add reaction acknowledgments (✅ for approve, ❌ for deny)
  - [ ] Update card appearance after decision is made
  - [ ] Add decision timestamp and approver information
  - [ ] Implement card archiving and cleanup strategies
  - [ ] Test card rendering across different Slack clients

- [ ] Task 7: Integration Testing (All ACs)
  - [ ] Test complete approval workflow end-to-end
  - [ ] Test button interactions and callback handling
  - [ ] Test timeout scenarios for soft gates
  - [ ] Test hard gate blocking behavior
  - [ ] Test audit trail and compliance recording

## Dev Notes

### Previous Story Insights

This story builds on the Slack command implementation from Story 2.2 and integrates heavily with the policy-service from Story 1.5. The approval cards will be posted to the #mylo-approvals channel established in Story 2.1.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**ApprovalEvent Entity:**

- Primary entity for tracking approval decisions
- `id`: UUID - Unique approval event identifier
- `work_item_id`: UUID - Associated work item requiring approval
- `approver_id`: String - User identifier who made the decision
- `decision`: ApprovalDecision - Decision made (APPROVED, REJECTED, ESCALATED)
- `reason`: Text - Reason for decision
- `timestamp`: DateTime - When decision was made
- `policy_version`: String - Version of policy that was applied

**Policy Service Integration:**

- `PolicyEvaluationRequest` - Request for policy evaluation
- `PolicyEvaluationResult` - Result with approval requirements
- `ApprovalRequest` - Created when human approval needed
- `PolicyAuditEntry` - Audit trail for compliance

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Block Kit:**

- `POST /chat.postMessage` with blocks for approval cards
- `POST /reactions.add` for acknowledgment reactions
- Interactive button callbacks via Socket Mode
- Message updates for card state changes

**Policy Service Integration:**

- `POST /policies/evaluate` - Evaluate policies and create approvals
- `POST /policies/approve` - Process approval decisions
- `GET /policies/approvals/pending` - Get pending approvals
- `GET /policies/audit` - Audit trail queries

### Component Specifications

**Approval Card Block Kit Structure:**

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "Approval required for action: *Deploy to production*\nRun: `{{run_id}}`\nReason: {{reason}}"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "Requested by: <@{{user_id}}>, Priority: *{{priority}}*"
        }
      ]
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": { "type": "plain_text", "text": "Approve" },
          "style": "primary",
          "value": "approve:{{approval_id}}"
        },
        {
          "type": "button",
          "text": { "type": "plain_text", "text": "Deny" },
          "style": "danger",
          "value": "deny:{{approval_id}}"
        },
        {
          "type": "button",
          "text": { "type": "plain_text", "text": "Skip" },
          "value": "skip:{{approval_id}}"
        },
        {
          "type": "button",
          "text": { "type": "plain_text", "text": "Abort" },
          "value": "abort:{{approval_id}}"
        }
      ]
    }
  ]
}
```

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Notification Service Extensions:**

- `packages/notification-service/src/services/approval-card.service.ts` - Approval card generation and management
- `packages/notification-service/src/controllers/approval-interactions.controller.ts` - Button interaction handling
- `packages/notification-service/src/templates/approval-card.template.ts` - Block Kit templates
- `packages/notification-service/src/services/approval-timeout.service.ts` - Timeout handling

**Policy Service Integration:**

- `packages/policy-service/src/services/policy.service.ts` - Existing approval workflow logic
- `packages/policy-service/src/controllers/policy.controller.ts` - Approval decision endpoints

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Tests:**

- Test approval card Block Kit generation
- Test button interaction parsing and routing
- Test timeout handling logic
- Test approval decision processing
- Test audit trail recording
- Mock all external service calls

**Integration Tests:**

- Test complete approval workflow from policy evaluation to decision
- Test button interactions with simulated Slack callbacks
- Test timeout scenarios with background job processing
- Test hard gate blocking behavior
- Test audit trail and compliance recording

**Test Files:**

- `packages/notification-service/test/approval-card.service.test.ts`
- `packages/notification-service/test/approval-interactions.controller.test.ts`
- `packages/policy-service/test/approval-workflow.integration.test.ts`

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Slack SDK:** @slack/bolt 3.17.0 for Block Kit and interactions
**Framework:** NestJS 10.3.2 with background job scheduling
**Database ORM:** Prisma 5.7.0 for approval event persistence
**Validation:** Joi 17.11.0 for interaction payload validation
**Logging:** Winston 3.11.0 with audit-specific log levels

### Approval Workflow Integration

**Policy Evaluation Lifecycle:**

1. Orchestrator/tool requests policy evaluation → `POST /policies/evaluate`
2. If approval required → create `approval_id`, generate card, post to #mylo-approvals
3. User clicks button → interaction callback processed
4. Decision recorded → update evaluation, audit trail, notify calling context
5. Card updated with decision and timestamp

**Timeout Handling:**

- Soft gates: configurable timeout (default 24h) with auto-approval
- Hard gates: no timeout, blocks indefinitely until human decision
- Background job checks for expired approvals and processes timeouts
- Timeout notifications posted to #mylo-approvals channel

### Button Interaction Handling

**Interaction Flow:**

1. User clicks button → Slack sends interaction payload via Socket Mode
2. Parse payload and extract `approval_id` from button value
3. Authorize user as valid approver for the approval
4. Process decision via policy-service
5. Update card with decision status and add reaction
6. Record audit entry and notify workflow of decision

**Button States:**

- Active: clickable buttons for pending approvals
- Decided: disabled buttons with decision indicator
- Timeout: special styling for auto-approved soft gates

### Integration Points

**With Previous Stories:**

- Uses Slack app and channels from Story 2.1
- Integrates with command system from Story 2.2
- Posts cards to #mylo-approvals channel

**With Future Stories:**

- Integrates with policy engine from Story 2.4
- Uses threading strategy from Story 2.5
- Supports workflow status updates

**With Policy Service:**

- `PolicyService.evaluatePolicy()` - Trigger approval creation
- `PolicyService.processApproval()` - Handle approval decisions
- `PolicyService.getAuditTrail()` - Compliance and reporting

### Environment Variables Required

From `.env.example` [Source: .env.example]:

- `SLACK_BOT_TOKEN` - For posting approval cards and reactions
- `SLACK_SIGNING_SECRET` - For interaction verification
- `POLICY_SERVICE_URL` - For approval workflow integration
- `NOTIFICATION_SERVICE_PORT` - Service configuration

### Security Considerations

**Approval Authorization:**

- Verify approver is authorized for specific approval type
- Check approval hasn't already been decided
- Validate approval hasn't expired (for soft gates)
- Log all authorization attempts for audit

**Interaction Security:**

- Verify Slack interaction signatures
- Validate button payload format and approval_id
- Rate limit approval interactions per user
- Sanitize all user inputs in approval context

### Testing

Based on architecture test strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Test Requirements:**

- Test Block Kit card generation with various approval types
- Test button interaction parsing and validation
- Test timeout handling and auto-approval logic
- Test approval decision processing and audit recording
- Mock Slack API calls and policy service interactions

**Integration Test Requirements:**

- Test complete approval workflow from creation to decision
- Test button interactions using simulated Slack callbacks
- Test timeout scenarios with background job execution
- Test hard gate blocking and escalation behavior
- Test audit trail completeness and compliance requirements

**Test Coverage Target:** 80% for approval workflow logic

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be populated by Dev agent_

## QA Results

_To be populated by QA agent_
