# Story 2.4: Policy Engine Implementation

## Status

Draft

## Story

**As a** system administrator,
**I want** a configurable policy engine that can make automated decisions,
**so that** the platform can handle routine approvals while escalating complex decisions to humans.

## Acceptance Criteria

1. Policy engine with declarative rule configuration
2. Support for allow, soft_gate, and deny outcomes
3. Policy evaluation based on capability, tool metadata, and context
4. Timeout configuration for soft gates
5. Policy dry-run mode for testing

## Tasks / Subtasks

- [ ] Task 1: Implement Declarative Policy Configuration (AC: 1)
  - [ ] Design policy rule schema with conditions and actions
  - [ ] Support JSON-based policy definitions
  - [ ] Implement policy versioning and updates
  - [ ] Create policy validation and schema compliance
  - [ ] Support policy inheritance and composition

- [ ] Task 2: Implement Policy Outcome Types (AC: 2)
  - [ ] Implement `allow` outcome for automatic approval
  - [ ] Implement `soft_gate` outcome with timeout-based auto-approval
  - [ ] Implement `deny` outcome for automatic rejection
  - [ ] Support outcome-specific metadata and reasoning
  - [ ] Handle outcome transitions and state management

- [ ] Task 3: Context-Based Policy Evaluation (AC: 3)
  - [ ] Implement capability-based evaluation (user permissions, tool access)
  - [ ] Evaluate based on tool metadata (sensitivity, side effects)
  - [ ] Support context evaluation (time, environment, request source)
  - [ ] Implement condition operators (equals, greater_than, contains, regex)
  - [ ] Support complex boolean logic (AND, OR, NOT)

- [ ] Task 4: Soft Gate Timeout Configuration (AC: 4)
  - [ ] Implement configurable timeout periods per policy
  - [ ] Default 24-hour timeout for soft gates
  - [ ] Background job for timeout processing
  - [ ] Timeout notification and auto-approval handling
  - [ ] Support different timeout strategies (escalate, approve, deny)

- [ ] Task 5: Policy Dry-Run Mode (AC: 5)
  - [ ] Implement dry-run evaluation without side effects
  - [ ] Return policy evaluation results without creating approvals
  - [ ] Support policy testing and validation workflows
  - [ ] Dry-run reporting and analysis capabilities
  - [ ] Integration with policy development and testing tools

- [ ] Task 6: Policy Management APIs (AC: 1, 5)
  - [ ] Create policy CRUD operations (create, read, update, delete)
  - [ ] Implement policy activation/deactivation
  - [ ] Support policy import/export functionality
  - [ ] Policy evaluation history and analytics
  - [ ] Policy performance monitoring and optimization

- [ ] Task 7: Integration Testing (All ACs)
  - [ ] Test policy evaluation with various contexts and conditions
  - [ ] Test all outcome types and their behaviors
  - [ ] Test timeout handling and background processing
  - [ ] Test dry-run mode accuracy and safety
  - [ ] Test policy management and lifecycle operations

## Dev Notes

### Previous Story Insights

This story builds on the approval card system from Story 2.3 and extends the existing policy-service from Story 1.5. The policy engine will integrate with the approval workflow to make automated decisions and create approval cards only when human intervention is required.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**Existing Policy Service Entities (from Story 1.5):**

- `PolicyRule` - Policy definitions with conditions and actions
- `PolicyCondition` - Individual policy conditions with operators
- `PolicyAction` - Actions to take based on policy evaluation
- `PolicyEvaluationRequest` - Request for policy evaluation
- `PolicyEvaluationResult` - Evaluation results with decisions
- `ApprovalRequest` - Created when human approval needed
- `PolicyAuditEntry` - Audit trail for compliance

**Enhanced Policy Schema:**

```typescript
interface PolicyRule {
  id: string;
  name: string;
  description: string;
  version: string;
  conditions: PolicyCondition[];
  outcome: 'allow' | 'soft_gate' | 'deny';
  timeout_hours?: number; // For soft_gate only
  metadata: {
    capability_requirements: string[];
    tool_sensitivity_levels: string[];
    context_requirements: Record<string, any>;
  };
  is_active: boolean;
  created_at: Date;
  updated_at: Date;
}
```

### API Specifications

**Enhanced Policy Service APIs:**

- `POST /policies` - Create new policy
- `GET /policies/{id}` - Get policy by ID
- `PUT /policies/{id}` - Update existing policy
- `DELETE /policies/{id}` - Delete policy
- `POST /policies/evaluate` - Evaluate policy (existing, enhanced)
- `POST /policies/evaluate?dry_run=true` - Dry-run evaluation
- `GET /policies/active` - List active policies
- `GET /policies/{id}/history` - Policy evaluation history

**Policy Evaluation Context:**

```typescript
interface EvaluationContext {
  user_id: string;
  capabilities: string[];
  tool_metadata: {
    name: string;
    sensitivity_level: 'low' | 'medium' | 'high' | 'critical';
    side_effects: 'none' | 'read' | 'write' | 'external';
  };
  request_context: {
    timestamp: string;
    environment: 'dev' | 'staging' | 'prod';
    source: string;
    metadata: Record<string, any>;
  };
}
```

### Component Specifications

**Policy Engine Architecture:**

- Policy Rule Engine: evaluates conditions and determines outcomes
- Context Evaluator: processes capability, tool, and request context
- Timeout Manager: handles soft gate timeouts and auto-approval
- Audit Manager: tracks all policy decisions and changes
- Dry-Run Processor: safe evaluation without side effects

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Policy Service Extensions:**

- `packages/policy-service/src/services/policy-engine.service.ts` - Core policy evaluation engine
- `packages/policy-service/src/services/policy-rule.service.ts` - Policy CRUD operations
- `packages/policy-service/src/services/timeout-manager.service.ts` - Soft gate timeout handling
- `packages/policy-service/src/evaluators/context-evaluator.ts` - Context-based evaluation
- `packages/policy-service/src/evaluators/condition-evaluator.ts` - Condition evaluation logic
- `packages/policy-service/src/controllers/policy-management.controller.ts` - Policy management APIs

**Configuration:**

- `packages/policy-service/src/config/default-policies.json` - Default policy definitions
- `packages/policy-service/src/schemas/policy-schema.json` - Policy validation schema

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Tests:**

- Test policy condition evaluation with all operators
- Test outcome determination logic (allow, soft_gate, deny)
- Test timeout handling and background processing
- Test dry-run mode safety and accuracy
- Test policy validation and schema compliance
- Mock all external dependencies and database calls

**Integration Tests:**

- Test complete policy evaluation workflows
- Test integration with approval card system
- Test timeout processing with background jobs
- Test policy management lifecycle operations
- Test context evaluation with real capability data

**Test Files:**

- `packages/policy-service/test/policy-engine.service.test.ts`
- `packages/policy-service/test/context-evaluator.test.ts`
- `packages/policy-service/test/timeout-manager.service.test.ts`
- `packages/policy-service/test/policy-integration.test.ts`

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Framework:** NestJS 10.3.2 with background job scheduling
**Database ORM:** Prisma 5.7.0 for policy and audit persistence
**Validation:** Joi 17.11.0 for policy schema validation
**Logging:** Winston 3.11.0 with audit-specific log levels
**Background Jobs:** NestJS Bull/Redis for timeout processing

### Policy Configuration Examples

**High-Value Transaction Policy:**

```json
{
  "id": "high_value_transaction",
  "name": "High Value Transaction Approval",
  "description": "Requires approval for transactions over $10,000",
  "version": "1.0.0",
  "conditions": [
    {
      "field": "tool_metadata.transaction_amount",
      "operator": "greater_than",
      "value": 10000,
      "description": "Transaction amount exceeds $10,000"
    }
  ],
  "outcome": "soft_gate",
  "timeout_hours": 24,
  "metadata": {
    "capability_requirements": ["financial_approval"],
    "tool_sensitivity_levels": ["high", "critical"],
    "context_requirements": {
      "environment": ["prod", "staging"]
    }
  },
  "is_active": true
}
```

**Sensitive Data Access Policy:**

```json
{
  "id": "sensitive_data_access",
  "name": "Sensitive Data Access Control",
  "description": "Controls access to sensitive customer data",
  "version": "1.0.0",
  "conditions": [
    {
      "field": "tool_metadata.data_classification",
      "operator": "equals",
      "value": "SENSITIVE",
      "description": "Data is classified as sensitive"
    },
    {
      "field": "user_capabilities",
      "operator": "contains",
      "value": "data_access_sensitive",
      "description": "User has sensitive data access capability"
    }
  ],
  "outcome": "allow",
  "metadata": {
    "capability_requirements": ["data_access_sensitive"],
    "tool_sensitivity_levels": ["high", "critical"],
    "context_requirements": {}
  },
  "is_active": true
}
```

### Condition Evaluation Operators

**Supported Operators:**

- `equals`: Exact match comparison
- `not_equals`: Negated exact match
- `greater_than`: Numeric greater than comparison
- `less_than`: Numeric less than comparison
- `contains`: String/array contains check
- `regex`: Regular expression pattern matching
- `in`: Value in array/list check
- `exists`: Field existence check

**Boolean Logic:**

- Multiple conditions within a policy are AND-ed together
- Support for OR logic through policy composition
- NOT logic through negated operators (not_equals, etc.)

### Timeout Management

**Soft Gate Timeout Process:**

1. Policy evaluation creates approval with timeout
2. Background job scheduled for timeout processing
3. On timeout: auto-approve and notify #mylo-approvals
4. Update approval card with timeout status
5. Continue workflow with approved status

**Timeout Configuration:**

- Per-policy timeout settings (default 24 hours)
- Configurable timeout strategies (approve, deny, escalate)
- Timeout escalation for critical decisions
- Emergency override capabilities for admins

### Integration Points

**With Previous Stories:**

- Extends policy-service from Story 1.5
- Integrates with approval cards from Story 2.3
- Uses Slack notifications from Stories 2.1-2.2

**With Future Stories:**

- Provides policy decisions for channel management (Story 2.5)
- Supports workflow integration and status updates
- Enables comprehensive audit and compliance reporting

**With External Systems:**

- Capability token system for user permissions
- Tool registry for metadata and sensitivity levels
- Workflow orchestrator for decision routing

### Environment Variables Required

From `.env.example` [Source: .env.example]:

- `POLICY_SERVICE_PORT` - Service configuration
- `REDIS_URL` - For background job processing
- `DATABASE_URL` - For policy and audit persistence
- `LOG_LEVEL` - For audit and debug logging

### Security Considerations

**Policy Security:**

- Validate all policy configurations against schema
- Restrict policy modification to authorized administrators
- Audit all policy changes and evaluations
- Secure policy storage and version control

**Evaluation Security:**

- Sanitize all evaluation context inputs
- Prevent policy injection attacks
- Rate limit policy evaluation requests
- Log security-relevant policy decisions

### Testing

Based on architecture test strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Test Requirements:**

- Test all condition operators with edge cases
- Test outcome determination and state transitions
- Test timeout handling and background job processing
- Test dry-run mode safety and isolation
- Test policy validation and error handling
- Mock all external dependencies and time-dependent operations

**Integration Test Requirements:**

- Test complete policy evaluation workflows
- Test integration with approval card generation
- Test timeout processing with real background jobs
- Test policy management APIs and lifecycle
- Test context evaluation with realistic data
- Test audit trail completeness and accuracy

**Test Coverage Target:** 80% for policy evaluation logic

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be populated by Dev agent_

## QA Results

_To be populated by QA agent_
