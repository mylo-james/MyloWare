# Story 1.3: Temporal Workflow Engine Setup

## Status
Approved

## Story
**As a** developer,
**I want** Temporal configured for workflow orchestration,
**so that** the platform can execute deterministic workflows with retries, timers, and idempotency.

## Acceptance Criteria
1. Temporal server deployed and configured
2. Workflow definitions established for the Docs Extract & Verify workflow
3. Activity implementations for all workflow steps
4. Retry policies and error handling configured
5. Temporal UI accessible for workflow monitoring and debugging

## Tasks / Subtasks
- [ ] Task 1: Deploy and configure Temporal server (AC: 1)
  - [ ] Set up Temporal server in Docker Compose environment
  - [ ] Configure Temporal database connection
  - [ ] Set up Temporal UI for monitoring and debugging
  - [ ] Configure Temporal server settings and parameters
- [ ] Task 2: Create workflow definitions (AC: 2)
  - [ ] Define Docs Extract & Verify workflow structure
  - [ ] Create workflow interfaces and types
  - [ ] Implement workflow state management
  - [ ] Set up workflow versioning and compatibility
- [ ] Task 3: Implement workflow activities (AC: 3)
  - [ ] Create activity interfaces for all workflow steps
  - [ ] Implement RecordGen activity
  - [ ] Implement ExtractorLLM activity
  - [ ] Implement JsonRestyler activity
  - [ ] Implement SchemaGuard activity
  - [ ] Implement Persister activity
  - [ ] Implement Verifier activity
- [ ] Task 4: Configure retry policies and error handling (AC: 4)
  - [ ] Set up exponential backoff retry policies
  - [ ] Implement circuit breaker patterns for external APIs
  - [ ] Configure timeout settings for activities
  - [ ] Set up error handling and recovery mechanisms
  - [ ] Implement dead letter queue for failed activities
- [ ] Task 5: Set up monitoring and debugging (AC: 5)
  - [ ] Configure Temporal UI access
  - [ ] Set up workflow monitoring and alerting
  - [ ] Implement workflow tracing and logging
  - [ ] Create debugging tools and utilities

## Dev Notes

### Previous Story Insights
This story builds on Stories 1.1 and 1.2. The Temporal setup will use the project structure from Story 1.1 and the database schema from Story 1.2 for workflow state persistence.

### Data Models
Based on architecture data models [Source: docs/architecture/data-models.md]:

**Workflow-Related Entities:**
- **WorkOrder**: Contains `workflow_id` field linking to Temporal workflow
- **WorkItem**: Individual items processed by workflow activities
- **Attempt**: Tracks activity execution attempts and results
- **WorkflowTemplate**: Stores workflow definitions for different document types

**Workflow State Management:**
- Workflow execution state stored in Temporal
- Work order status synchronized with workflow state
- Activity results stored in attempts table
- Workflow metadata stored in work_order.metadata field

### API Specifications
No external API specifications for this story - this is internal workflow orchestration setup.

### Component Specifications
No UI components for this story - this is backend workflow orchestration setup.

### File Locations
Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Temporal Service:**
- `packages/workflow-service/` - Temporal workflow orchestration
  - `src/main.ts` - Service entry point
  - `src/workflows/` - Temporal workflow definitions
  - `src/activities/` - Workflow activities implementation
  - `src/services/` - Workflow services
  - `src/types/` - TypeScript type definitions

**Docker Configuration:**
- `docker-compose.yml` - Temporal server configuration
- `docker-compose.prod.yml` - Production Temporal setup

### Testing Requirements
Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Temporal Testing:**
- Unit tests for workflow definitions
- Integration tests for activity implementations
- End-to-end workflow testing
- Retry policy and error handling tests
- Performance testing for workflow execution

**Test Coverage:**
- Workflow definition tests
- Activity implementation tests
- Error handling and recovery tests
- Workflow state management tests

### Technical Constraints
Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Workflow Engine:** Temporal 1.22.0
**Language:** TypeScript 5.3.3
**Framework:** NestJS 10.3.2 for service implementation
**Database:** PostgreSQL 15.5 for Temporal persistence
**Logging:** Winston 3.11.0 for structured logging

**Temporal Configuration:**
- Deterministic execution with retries and idempotency
- Workflow versioning and compatibility
- Activity timeout and retry policies
- Circuit breaker patterns for external API calls

### Workflow Architecture
Based on architecture core workflows [Source: docs/architecture/core-workflows.md]:

**Docs Extract & Verify Workflow:**
1. **RecordGen Activity**: Generate initial records and context
2. **ExtractorLLM Activity**: Extract data from documents using LLM
3. **JsonRestyler Activity**: Transform data to consistent JSON format
4. **SchemaGuard Activity**: Validate data against schemas
5. **Persister Activity**: Persist validated data to database
6. **Verifier Activity**: Perform final verification and quality assurance

**Error Handling Strategy:**
- Exponential backoff retry policies
- Circuit breaker for external LLM API calls
- Dead letter queue for failed activities
- Workflow compensation for rollback scenarios

### Environment Variables Required
- `TEMPORAL_HOST` - Temporal server host (default: localhost)
- `TEMPORAL_PORT` - Temporal server port (default: 7233)
- `TEMPORAL_NAMESPACE` - Temporal namespace (default: default)
- `TEMPORAL_TASK_QUEUE` - Task queue name (default: myloware-tasks)
- `TEMPORAL_DATABASE_URL` - Temporal database connection string
- `TEMPORAL_UI_HOST` - Temporal UI host (default: localhost)
- `TEMPORAL_UI_PORT` - Temporal UI port (default: 8233)

### Integration Points
**With Previous Stories:**
- Uses database schema from Story 1.2 for workflow state persistence
- Integrates with project structure from Story 1.1
- Connects to Redis event bus (Story 1.4 dependency)

**With Future Stories:**
- Provides workflow orchestration for AI agents (Epic 3)
- Supports human-in-the-loop approval workflows (Epic 2)
- Enables document processing workflows (Epic 4)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*
