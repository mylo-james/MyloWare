# Story 1.5: Core MCP Services Foundation

## Status

Approved

## Story

**As a** developer,
**I want** the foundational MCP services (Board, Memory, Notify, Policy) established,
**so that** the platform has the core building blocks for agent orchestration and communication.

## Acceptance Criteria

1. MCP protocol implementation with JSON-RPC 2.0 over WebSocket
2. Board MCP service for work order dispensation
3. Memory MCP service for knowledge management
4. Notify MCP service for Slack integration
5. Policy MCP service for HITL decisions
6. Service discovery and health check endpoints

## Tasks / Subtasks

- [ ] Task 1: Implement MCP protocol foundation (AC: 1)
  - [ ] Set up JSON-RPC 2.0 over WebSocket implementation
  - [ ] Create MCP protocol message handlers
  - [ ] Implement MCP service registration and discovery
  - [ ] Set up MCP protocol versioning and compatibility
- [ ] Task 2: Create Board MCP service (AC: 2)
  - [ ] Implement work order dispensation logic
  - [ ] Create work order queue management
  - [ ] Set up work order assignment and routing
  - [ ] Implement work order status tracking
- [ ] Task 3: Create Memory MCP service (AC: 3)
  - [ ] Implement knowledge storage and retrieval
  - [ ] Set up vector similarity search with pgvector
  - [ ] Create memory document management
  - [ ] Implement memory optimization and cleanup
- [ ] Task 4: Create Notify MCP service (AC: 4)
  - [ ] Implement Slack integration endpoints
  - [ ] Create notification templating system
  - [ ] Set up notification delivery and tracking
  - [ ] Implement notification preferences and routing
- [ ] Task 5: Create Policy MCP service (AC: 5)
  - [ ] Implement human-in-the-loop policy evaluation
  - [ ] Create approval workflow management
  - [ ] Set up policy versioning and updates
  - [ ] Implement audit trail and compliance tracking
- [ ] Task 6: Set up service discovery and health checks (AC: 6)
  - [ ] Implement service registration and discovery
  - [ ] Create health check endpoints for all services
  - [ ] Set up service monitoring and alerting
  - [ ] Implement service failover and recovery

## Dev Notes

### Previous Story Insights

This story builds on all previous Epic 1 stories. The MCP services will use the project structure from Story 1.1, database schema from Story 1.2, Temporal workflows from Story 1.3, and event bus from Story 1.4 for communication.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**MCP Service-Related Entities:**

- **WorkOrder**: Primary entity for Board MCP service
- **MemDoc**: Primary entity for Memory MCP service
- **ApprovalEvent**: Primary entity for Policy MCP service
- **Connector**: Configuration for Notify MCP service

**MCP Service Components:**

- **Board Service**: Manages work order dispensation and routing
- **Memory Service**: Handles knowledge storage and retrieval
- **Notify Service**: Manages external notifications and integrations
- **Policy Service**: Evaluates policies and manages approvals

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Integration (for Notify Service):**

- `POST /chat.postMessage` - Send messages to channels or users
- `POST /views.open` - Open modal dialogs for user interaction
- `POST /chat.postEphemeral` - Send temporary messages
- `GET /users.list` - Retrieve user information
- `POST /reactions.add` - Add reactions to messages

### Component Specifications

No UI components for this story - this is backend MCP service implementation.

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**MCP Services:**

- `packages/memory-service/` - Memory and context management
  - `src/main.ts` - Service entry point
  - `src/services/` - Memory services
  - `src/repositories/` - Data access layer
  - `src/models/` - Memory models
  - `src/types/` - TypeScript type definitions

- `packages/policy-service/` - Human-in-the-loop policies
  - `src/main.ts` - Service entry point
  - `src/policies/` - Policy definitions
  - `src/services/` - Policy services
  - `src/evaluators/` - Policy evaluators
  - `src/types/` - TypeScript type definitions

- `packages/notification-service/` - Notifications and integrations
  - `src/main.ts` - Service entry point
  - `src/integrations/` - External integrations
  - `src/services/` - Notification services
  - `src/templates/` - Notification templates
  - `src/types/` - TypeScript type definitions

**Board Service (Workflow Integration):**

- `packages/workflow-service/` - Includes Board MCP functionality
  - `src/services/board.service.ts` - Work order dispensation
  - `src/services/workflow.service.ts` - Workflow orchestration

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**MCP Service Testing:**

- Unit tests for all MCP service implementations
- Integration tests for MCP protocol communication
- End-to-end MCP service workflow testing
- Performance testing for MCP service interactions
- Security testing for MCP service authentication

**Test Coverage:**

- MCP protocol implementation tests
- Service-specific functionality tests
- Integration and communication tests
- Error handling and recovery tests

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**MCP Protocol:** JSON-RPC 2.0 over WebSocket
**Language:** TypeScript 5.3.3
**Framework:** NestJS 10.3.2 for service implementation
**Database:** PostgreSQL 15.5 with pgvector 0.5.0 for memory service
**Slack SDK:** @slack/bolt 3.17.0 for notification service
**Logging:** Winston 3.11.0 for structured logging
**Validation:** Joi 17.11.0 for data validation

### MCP Service Architecture

Based on architecture components [Source: docs/architecture/components.md]:

**Board MCP Service:**

- **Work Order Dispensation**: Manages work order assignment and routing
- **Queue Management**: Handles work order queuing and prioritization
- **Status Tracking**: Monitors work order processing status
- **Load Balancing**: Distributes work orders across available agents

**Memory MCP Service:**

- **Knowledge Storage**: Stores and retrieves memory documents
- **Vector Search**: Implements similarity search using pgvector
- **Context Management**: Manages agent context and history
- **Memory Optimization**: Handles memory cleanup and optimization

**Notify MCP Service:**

- **Slack Integration**: Manages Slack API communication
- **Notification Templating**: Creates and manages notification templates
- **Delivery Tracking**: Tracks notification delivery and status
- **Routing Logic**: Routes notifications to appropriate channels

**Policy MCP Service:**

- **Policy Evaluation**: Evaluates policies for human-in-the-loop decisions
- **Approval Management**: Manages approval workflows and decisions
- **Audit Trail**: Tracks policy decisions and compliance
- **Version Control**: Manages policy versions and updates

### Environment Variables Required

- `MCP_HOST` - MCP service host (default: localhost)
- `MCP_PORT` - MCP service port (default: 8080)
- `MCP_PROTOCOL_VERSION` - MCP protocol version (default: 1.0)
- `SLACK_BOT_TOKEN` - Slack bot token for notification service
- `SLACK_SIGNING_SECRET` - Slack signing secret for verification
- `SLACK_APP_TOKEN` - Slack app token for Socket Mode
- `MEMORY_SERVICE_URL` - Memory service connection URL
- `POLICY_SERVICE_URL` - Policy service connection URL
- `NOTIFY_SERVICE_URL` - Notify service connection URL

### Integration Points

**With Previous Stories:**

- Uses database schema from Story 1.2 for data persistence
- Integrates with project structure from Story 1.1
- Connects to Temporal workflows from Story 1.3
- Uses event bus from Story 1.4 for service communication

**With Future Stories:**

- Provides MCP services for AI agent orchestration (Epic 3)
- Supports Slack integration workflows (Epic 2)
- Enables document processing coordination (Epic 4)

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent_
