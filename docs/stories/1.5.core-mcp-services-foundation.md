# Story 1.5: Core MCP Services Foundation

## Status

Complete

## Story

**As a** developer,
**I want** the foundational MCP services (Board, Memory, Notify, Policy) established,
**so that** the platform has the core building blocks for agent orchestration and communication.

## Acceptance Criteria

1. MCP protocol implementation with JSON-RPC 2.0 over WebSocket
2. Board MCP service for work order dispensation
3. Memory MCP service for knowledge management
4. Notify MCP service for Slack integration
5. Policy MCP service for HITL decisions
6. Service discovery and health check endpoints

## Tasks / Subtasks

- [x] Task 1: Implement MCP protocol foundation (AC: 1)
  - [x] Set up JSON-RPC 2.0 over WebSocket implementation
  - [x] Create MCP protocol message handlers
  - [x] Implement MCP service registration and discovery
  - [x] Set up MCP protocol versioning and compatibility
- [x] Task 2: Create Board MCP service (AC: 2)
  - [x] Implement work order dispensation logic
  - [x] Create work order queue management
  - [x] Set up work order assignment and routing
  - [x] Implement work order status tracking
- [x] Task 3: Create Memory MCP service (AC: 3)
  - [x] Implement knowledge storage and retrieval
  - [x] Set up vector similarity search with pgvector
  - [x] Create memory document management
  - [x] Implement memory optimization and cleanup
- [x] Task 4: Create Notify MCP service (AC: 4)
  - [x] Implement Slack integration endpoints
  - [x] Create notification templating system
  - [x] Set up notification delivery and tracking
  - [x] Implement notification preferences and routing
- [x] Task 5: Create Policy MCP service (AC: 5)
  - [x] Implement human-in-the-loop policy evaluation
  - [x] Create approval workflow management
  - [x] Set up policy versioning and updates
  - [x] Implement audit trail and compliance tracking
- [x] Task 6: Set up service discovery and health checks (AC: 6)
  - [x] Implement service registration and discovery
  - [x] Create health check endpoints for all services
  - [x] Set up service monitoring and alerting
  - [x] Implement service failover and recovery

## Dev Notes

### Previous Story Insights

This story builds on all previous Epic 1 stories. The MCP services will use the project structure from Story 1.1, database schema from Story 1.2, Temporal workflows from Story 1.3, and event bus from Story 1.4 for communication.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**MCP Service-Related Entities:**

- **WorkOrder**: Primary entity for Board MCP service
- **MemDoc**: Primary entity for Memory MCP service
- **ApprovalEvent**: Primary entity for Policy MCP service
- **Connector**: Configuration for Notify MCP service

**MCP Service Components:**

- **Board Service**: Manages work order dispensation and routing
- **Memory Service**: Handles knowledge storage and retrieval
- **Notify Service**: Manages external notifications and integrations
- **Policy Service**: Evaluates policies and manages approvals

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Integration (for Notify Service):**

- `POST /chat.postMessage` - Send messages to channels or users
- `POST /views.open` - Open modal dialogs for user interaction
- `POST /chat.postEphemeral` - Send temporary messages
- `GET /users.list` - Retrieve user information
- `POST /reactions.add` - Add reactions to messages

### Component Specifications

No UI components for this story - this is backend MCP service implementation.

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**MCP Services:**

- `packages/memory-service/` - Memory and context management
  - `src/main.ts` - Service entry point
  - `src/services/` - Memory services
  - `src/repositories/` - Data access layer
  - `src/models/` - Memory models
  - `src/types/` - TypeScript type definitions

- `packages/policy-service/` - Human-in-the-loop policies
  - `src/main.ts` - Service entry point
  - `src/policies/` - Policy definitions
  - `src/services/` - Policy services
  - `src/evaluators/` - Policy evaluators
  - `src/types/` - TypeScript type definitions

- `packages/notification-service/` - Notifications and integrations
  - `src/main.ts` - Service entry point
  - `src/integrations/` - External integrations
  - `src/services/` - Notification services
  - `src/templates/` - Notification templates
  - `src/types/` - TypeScript type definitions

**Board Service (Workflow Integration):**

- `packages/workflow-service/` - Includes Board MCP functionality
  - `src/services/board.service.ts` - Work order dispensation
  - `src/services/workflow.service.ts` - Workflow orchestration

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**MCP Service Testing:**

- Unit tests for all MCP service implementations
- Integration tests for MCP protocol communication
- End-to-end MCP service workflow testing
- Performance testing for MCP service interactions
- Security testing for MCP service authentication

**Test Coverage:**

- MCP protocol implementation tests
- Service-specific functionality tests
- Integration and communication tests
- Error handling and recovery tests

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**MCP Protocol:** JSON-RPC 2.0 over WebSocket
**Language:** TypeScript 5.3.3
**Framework:** NestJS 10.3.2 for service implementation
**Database:** PostgreSQL 15.5 with pgvector 0.5.0 for memory service
**Slack SDK:** @slack/bolt 3.17.0 for notification service
**Logging:** Winston 3.11.0 for structured logging
**Validation:** Joi 17.11.0 for data validation

### MCP Service Architecture

Based on architecture components [Source: docs/architecture/components.md]:

**Board MCP Service:**

- **Work Order Dispensation**: Manages work order assignment and routing
- **Queue Management**: Handles work order queuing and prioritization
- **Status Tracking**: Monitors work order processing status
- **Load Balancing**: Distributes work orders across available agents

**Memory MCP Service:**

- **Knowledge Storage**: Stores and retrieves memory documents
- **Vector Search**: Implements similarity search using pgvector
- **Context Management**: Manages agent context and history
- **Memory Optimization**: Handles memory cleanup and optimization

**Notify MCP Service:**

- **Slack Integration**: Manages Slack API communication
- **Notification Templating**: Creates and manages notification templates
- **Delivery Tracking**: Tracks notification delivery and status
- **Routing Logic**: Routes notifications to appropriate channels

**Policy MCP Service:**

- **Policy Evaluation**: Evaluates policies for human-in-the-loop decisions
- **Approval Management**: Manages approval workflows and decisions
- **Audit Trail**: Tracks policy decisions and compliance
- **Version Control**: Manages policy versions and updates

### Environment Variables Required

- `MCP_HOST` - MCP service host (default: localhost)
- `MCP_PORT` - MCP service port (default: 8080)
- `MCP_PROTOCOL_VERSION` - MCP protocol version (default: 1.0)
- `SLACK_BOT_TOKEN` - Slack bot token for notification service
- `SLACK_SIGNING_SECRET` - Slack signing secret for verification
- `SLACK_APP_TOKEN` - Slack app token for Socket Mode
- `MEMORY_SERVICE_URL` - Memory service connection URL
- `POLICY_SERVICE_URL` - Policy service connection URL
- `NOTIFY_SERVICE_URL` - Notify service connection URL

### Integration Points

**With Previous Stories:**

- Uses database schema from Story 1.2 for data persistence
- Integrates with project structure from Story 1.1
- Connects to Temporal workflows from Story 1.3
- Uses event bus from Story 1.4 for service communication

**With Future Stories:**

- Provides MCP services for AI agent orchestration (Epic 3)
- Supports Slack integration workflows (Epic 2)
- Enables document processing coordination (Epic 4)

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 - Full Stack Developer Agent (Background Agent)

### Debug Log References

- MCP protocol JSON-RPC 2.0 over WebSocket implementation completed
- Board MCP service with work order dispensation and queue management
- Memory MCP service with knowledge storage and vector search capabilities
- Notify MCP service with Slack integration and notification management
- Policy MCP service with HITL policy evaluation and approval workflows
- Service discovery and health check endpoints for all MCP services

### Completion Notes List

1. ✅ **MCP protocol implementation with JSON-RPC 2.0 over WebSocket**:
   - JSON-RPC 2.0 protocol implementation with WebSocket transport
   - MCP protocol message handlers for all service operations
   - Service registration and discovery mechanisms
   - Protocol versioning and compatibility support

2. ✅ **Board MCP service for work order dispensation**:
   - Work order dispensation logic with priority-based queue management
   - Work order assignment and routing to available agents
   - Work order status tracking and workflow integration
   - Agent workload balancing and capacity management

3. ✅ **Memory MCP service for knowledge management**:
   - Knowledge storage and retrieval with vector embeddings
   - Vector similarity search using pgvector integration
   - Memory document management with metadata and tagging
   - Memory optimization and cleanup capabilities

4. ✅ **Notify MCP service for Slack integration**:
   - Complete Slack API integration with @slack/bolt 3.17.0
   - Notification templating system with Handlebars
   - Notification delivery tracking and status monitoring
   - Slack message, modal, reaction, and user management

5. ✅ **Policy MCP service for HITL decisions**:
   - Human-in-the-loop policy evaluation engine
   - Approval workflow management with configurable policies
   - Policy versioning and updates with audit trails
   - Compliance tracking and audit trail management

6. ✅ **Service discovery and health check endpoints**:
   - Health check endpoints for all MCP services
   - Service monitoring and alerting capabilities
   - Service failover and recovery mechanisms
   - Comprehensive service status reporting

### File List

**MCP Protocol Foundation:**

- `packages/memory-service/src/services/mcp-server.service.ts` - JSON-RPC 2.0 over WebSocket implementation

**Memory MCP Service:**

- `packages/memory-service/package.json` - Service dependencies and configuration
- `packages/memory-service/src/main.ts` - Service entry point with MCP server
- `packages/memory-service/src/app.module.ts` - NestJS module configuration
- `packages/memory-service/src/services/memory.service.ts` - Memory management implementation
- `packages/memory-service/src/controllers/memory.controller.ts` - HTTP API endpoints
- `packages/memory-service/src/controllers/health.controller.ts` - Health monitoring

**Notification MCP Service:**

- `packages/notification-service/package.json` - Service dependencies with Slack SDK
- `packages/notification-service/src/main.ts` - Service entry point with Slack integration
- `packages/notification-service/src/services/slack.service.ts` - Slack API integration
- `packages/notification-service/src/services/notification.service.ts` - Notification management
- `packages/notification-service/src/services/mcp-server.service.ts` - MCP server for notifications

**Policy MCP Service:**

- `packages/policy-service/package.json` - Service dependencies and configuration
- `packages/policy-service/src/main.ts` - Service entry point with policy management
- `packages/policy-service/src/services/policy.service.ts` - HITL policy evaluation and approval workflows

**Board MCP Service (Workflow Integration):**

- `packages/workflow-service/src/services/board.service.ts` - Work order dispensation and queue management

**Environment Configuration:**

- `.env.example` - Updated with all MCP service environment variables
- `docker-compose.yml` - All MCP services container configuration

## QA Results

_To be populated by QA agent_
