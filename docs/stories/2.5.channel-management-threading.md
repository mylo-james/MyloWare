# Story 2.5: Channel Management and Threading

## Status

Draft

## Story

**As a** user,
**I want** organized communication in dedicated channels with proper threading,
**so that** I can easily track workflow progress and maintain context.

## Acceptance Criteria

1. Run updates posted as threads in #mylo-feed keyed by run_id
2. Approval requests posted to #mylo-approvals channel
3. General commands and chat in #mylo-control channel
4. Thread management and cleanup strategies
5. Message formatting with consistent styling and metadata

## Tasks / Subtasks

- [ ] Task 1: Implement Run Threading in #mylo-feed (AC: 1)
  - [ ] Create initial thread message for new runs
  - [ ] Use returned `ts` as `thread_ts` for subsequent updates
  - [ ] Thread all run status updates and agent messages
  - [ ] Maintain thread context and run_id mapping
  - [ ] Handle thread archival and cleanup

- [ ] Task 2: Approval Channel Management (AC: 2)
  - [ ] Post all approval cards to #mylo-approvals channel
  - [ ] Thread approval discussions and decisions
  - [ ] Maintain approval card state and updates
  - [ ] Handle approval card archival after decisions
  - [ ] Support approval escalation and notifications

- [ ] Task 3: Control Channel Management (AC: 3)
  - [ ] Route slash command confirmations to #mylo-control
  - [ ] Handle general chat and user interactions
  - [ ] Support help commands and documentation
  - [ ] Manage bot announcements and status updates
  - [ ] Handle error messages and troubleshooting

- [ ] Task 4: Thread Management and Cleanup (AC: 4)
  - [ ] Implement thread lifecycle management
  - [ ] Auto-archive completed run threads after configurable period
  - [ ] Clean up stale approval threads
  - [ ] Thread search and discovery capabilities
  - [ ] Thread metadata and indexing for retrieval

- [ ] Task 5: Message Formatting and Styling (AC: 5)
  - [ ] Implement consistent message formatting with status tags
  - [ ] Add run metadata in compact table format
  - [ ] Include links to run trace UI (when available)
  - [ ] Support emoji status indicators and reactions
  - [ ] Consistent timestamp and user attribution

- [ ] Task 6: Channel Permissions and Security (All ACs)
  - [ ] Verify bot permissions in all channels
  - [ ] Handle channel access control and user permissions
  - [ ] Secure channel creation and management
  - [ ] Monitor channel health and bot presence
  - [ ] Handle channel archival and restoration

- [ ] Task 7: Integration Testing (All ACs)
  - [ ] Test complete threading workflows across all channels
  - [ ] Test message formatting and metadata consistency
  - [ ] Test cleanup and archival processes
  - [ ] Test channel permissions and security
  - [ ] Test error handling and fallback scenarios

## Dev Notes

### Previous Story Insights

This story completes the Epic 2 Slack integration by implementing the channel organization and threading strategy that supports the slash commands from Story 2.2, approval cards from Story 2.3, and policy decisions from Story 2.4.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**Thread Management Data:**

```typescript
interface ThreadContext {
  run_id: string;
  channel: string;
  thread_ts: string;
  created_at: Date;
  last_updated: Date;
  status: 'active' | 'completed' | 'archived';
  message_count: number;
  participants: string[];
}

interface ChannelConfig {
  name: string;
  purpose: 'feed' | 'approvals' | 'control';
  auto_archive_hours?: number;
  cleanup_policy: 'archive' | 'delete' | 'retain';
}
```

**No new database entities required** - threading is managed through Slack API and in-memory/cache storage.

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Threading:**

- `POST /chat.postMessage` with `thread_ts` for threaded messages
- `GET /conversations.history` for thread message retrieval
- `POST /conversations.archive` for channel archival
- `GET /conversations.info` for channel metadata
- `POST /chat.update` for message updates

**Internal Thread Management APIs:**

- `POST /threads/create` - Create new thread context
- `GET /threads/{run_id}` - Get thread information
- `POST /threads/{run_id}/update` - Update thread status
- `DELETE /threads/{run_id}` - Archive/cleanup thread

### Component Specifications

**Channel Organization:**

- **#mylo-feed**: Workflow run updates and progress tracking
  - One parent message per run_id
  - Threaded status updates and agent messages
  - Auto-archive after run completion + 7 days
- **#mylo-approvals**: Human-in-the-loop approval decisions
  - Approval cards with interactive buttons
  - Threaded approval discussions
  - Archive after decision + 30 days for audit

- **#mylo-control**: General commands and bot interaction
  - Slash command confirmations
  - Help and documentation requests
  - Bot status and announcements
  - No automatic archival

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Notification Service Extensions:**

- `packages/notification-service/src/services/thread-manager.service.ts` - Thread lifecycle management
- `packages/notification-service/src/services/channel-manager.service.ts` - Channel organization and permissions
- `packages/notification-service/src/services/message-formatter.service.ts` - Consistent message formatting
- `packages/notification-service/src/services/cleanup-scheduler.service.ts` - Background cleanup jobs
- `packages/notification-service/src/controllers/thread-management.controller.ts` - Thread management APIs

**Configuration:**

- `packages/notification-service/src/config/channel-config.json` - Channel configuration and policies
- `packages/notification-service/src/templates/message-templates.ts` - Message formatting templates

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Tests:**

- Test thread creation and management logic
- Test message formatting and template rendering
- Test cleanup scheduling and archival logic
- Test channel permission validation
- Test thread context mapping and retrieval
- Mock all Slack API calls

**Integration Tests:**

- Test complete threading workflows across channels
- Test message formatting consistency
- Test cleanup and archival processes with background jobs
- Test channel management and bot permissions
- Test thread search and discovery capabilities

**Test Files:**

- `packages/notification-service/test/thread-manager.service.test.ts`
- `packages/notification-service/test/channel-manager.service.test.ts`
- `packages/notification-service/test/message-formatter.service.test.ts`
- `packages/notification-service/test/threading-integration.test.ts`

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Slack SDK:** @slack/bolt 3.17.0 for threading and channel management
**Framework:** NestJS 10.3.2 with background job scheduling
**Cache:** Redis 7.2.0 for thread context caching
**Validation:** Joi 17.11.0 for message and thread validation
**Background Jobs:** NestJS Bull/Redis for cleanup scheduling

### Threading Strategy Implementation

**Run Thread Lifecycle:**

1. `/mylo new` command creates initial thread message in #mylo-feed
2. Store `run_id` â†’ `thread_ts` mapping in cache/database
3. All subsequent run updates use `thread_ts` for threading
4. Thread remains active until run completion + grace period
5. Auto-archive thread after configurable retention period

**Thread Context Management:**

```typescript
class ThreadManager {
  async createRunThread(runId: string, initialMessage: string): Promise<ThreadContext>;
  async updateRunThread(runId: string, message: string): Promise<void>;
  async getThreadContext(runId: string): Promise<ThreadContext | null>;
  async archiveThread(runId: string): Promise<void>;
}
```

### Message Formatting Standards

**Status Tag Format:**

- `[RUN {{run_id}}][STARTED]` - Workflow started
- `[RUN {{run_id}}][IN_PROGRESS]` - Workflow running
- `[RUN {{run_id}}][DONE]` - Workflow completed successfully
- `[RUN {{run_id}}][ERROR]` - Workflow failed
- `[APPROVAL {{approval_id}}][PENDING]` - Approval required
- `[APPROVAL {{approval_id}}][APPROVED]` - Approval granted

**Metadata Table Format:**

```
ðŸ“Š *Run Details*
â€¢ Status: In Progress
â€¢ Started: 2024-12-19 10:30 AM
â€¢ Duration: 5m 23s
â€¢ Agent: ExtractorLLM
â€¢ Progress: 3/5 documents processed
```

### Channel Cleanup Strategies

**Automated Cleanup Policies:**

- **#mylo-feed**: Archive threads 7 days after run completion
- **#mylo-approvals**: Archive threads 30 days after approval decision
- **#mylo-control**: No automatic cleanup (manual management)

**Cleanup Implementation:**

- Background job runs daily to identify stale threads
- Configurable retention periods per channel
- Grace period for active/recent threads
- Admin override for manual cleanup control

### Channel Permissions and Security

**Bot Permission Requirements:**

- `chat:write` - Post messages to all channels
- `chat:write.customize` - Custom message formatting
- `channels:read` - Read channel information
- `reactions:write` - Add status reactions

**Security Considerations:**

- Verify bot has required permissions before posting
- Handle permission errors gracefully with fallback
- Log security events for audit and monitoring
- Respect channel privacy and access controls

### Integration Points

**With Previous Stories:**

- Receives thread seeds from slash commands (Story 2.2)
- Posts approval cards to #mylo-approvals (Story 2.3)
- Integrates with policy decisions and notifications (Story 2.4)
- Uses Slack app configuration from Story 2.1

**With Workflow System:**

- Receives workflow status updates for threading
- Provides thread context for workflow communication
- Supports workflow cancellation and control messages

**With Future Features:**

- Integration with Run Trace UI links (Epic 6)
- Support for dashboard and observability (Epic 6)
- Enhanced search and discovery capabilities

### Environment Variables Required

From `.env.example` [Source: .env.example]:

- `SLACK_BOT_TOKEN` - For channel and thread management
- `REDIS_URL` - For thread context caching
- `NOTIFICATION_SERVICE_PORT` - Service configuration

### Error Handling and Fallbacks

**Thread Management Errors:**

- Lost thread context: create new thread with continuation notice
- Channel access errors: fallback to #mylo-control with error notice
- Rate limiting: queue messages and retry with exponential backoff
- Bot permission errors: log and notify admins

**Cleanup Failures:**

- Archive failures: retry with exponential backoff
- Permission errors: skip and log for manual intervention
- Partial cleanup: maintain cleanup state and resume

### Testing

Based on architecture test strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Test Requirements:**

- Test thread creation and lifecycle management
- Test message formatting with various status types
- Test cleanup scheduling and archival logic
- Test channel permission validation and error handling
- Test thread context caching and retrieval
- Mock all Slack API interactions

**Integration Test Requirements:**

- Test complete threading workflows across all channels
- Test message formatting consistency and metadata
- Test cleanup processes with background job execution
- Test channel management and bot permission handling
- Test error scenarios and fallback behavior
- Test thread search and discovery functionality

**Test Coverage Target:** 80% for thread and channel management logic

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be populated by Dev agent_

## QA Results

_To be populated by QA agent_
