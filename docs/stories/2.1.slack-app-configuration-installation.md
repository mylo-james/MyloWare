# Story 2.1: Slack App Configuration and Installation

## Status

Approved

## Story

**As a** user,
**I want** to install and configure the MyloWare Slack app,
**so that** I can interact with the platform through familiar Slack channels.

## Acceptance Criteria

1. Slack app created with required scopes and permissions
2. Socket Mode enabled for MVP deployment
3. App installation process documented and tested
4. Required channels (#mylo-control, #mylo-approvals, #mylo-feed) created
5. Bot user configured with appropriate permissions

## Tasks / Subtasks

- [x] Task 1: Create Slack App with Required Scopes (AC: 1)
  - [x] Create new Slack app in workspace
  - [x] Configure bot token scopes: `chat:write`, `chat:write.customize`, `commands`, `reactions:write`, `users:read`
  - [x] Optional scopes for modals: `chat:write.public`, `channels:read`
  - [x] Generate and secure bot token (`SLACK_BOT_TOKEN`)
  - [x] Generate and secure signing secret (`SLACK_SIGNING_SECRET`)

- [x] Task 2: Enable Socket Mode Configuration (AC: 2)
  - [x] Enable Socket Mode in Slack app settings
  - [x] Generate app-level token with `connections:write` scope
  - [x] Configure `SLACK_APP_TOKEN` environment variable
  - [x] Test Socket Mode connection in `SlackService`

- [x] Task 3: Document Installation Process (AC: 3)
  - [x] Create installation guide in README
  - [x] Document environment variable configuration
  - [x] Create smoke test endpoint for Slack connectivity
  - [x] Document troubleshooting common issues

- [x] Task 4: Create Required Channels (AC: 4)
  - [x] Create `#mylo-control` channel for commands and chat
  - [x] Create `#mylo-approvals` channel for approval cards
  - [x] Create `#mylo-feed` channel for workflow updates
  - [x] Invite bot user to all channels
  - [x] Test message posting to each channel

- [x] Task 5: Configure Bot User Permissions (AC: 5)
  - [x] Verify bot user has required permissions in each channel
  - [x] Test bot can post messages, reactions, and ephemeral messages
  - [later] Configure bot user display name and avatar
  - [x] Test bot user profile and presence

- [x] Task 6: Integration Testing (All ACs)
  - [x] Test complete installation flow
  - [x] Test smoke test endpoint: `POST /api/v1/notifications/slack/test`
  - [x] Test Socket Mode connectivity
  - [x] Test simulation mode fallback when tokens absent
  - [x] Verify all environment variables properly configured

## Dev Notes

### Previous Story Insights

This story builds on the MCP services foundation from Story 1.5, specifically the Notify MCP service. The `notification-service` already has Slack integration capabilities with `SlackService` that supports simulation mode for development.

### Data Models

Based on architecture data models [Source: docs/architecture/data-models.md]:

**Connector Entity:**

- Used to store Slack app configuration and connection status
- `type`: SLACK
- `config`: JSON containing bot token, signing secret, app token
- `status`: ACTIVE, INACTIVE, ERROR for connection health

**No specific data models needed for this story** - configuration is primarily environment-based.

### API Specifications

Based on architecture external APIs [Source: docs/architecture/external-apis.md]:

**Slack API Integration:**

- `POST /chat.postMessage` - Send messages to channels or users
- `POST /views.open` - Open modal dialogs for user interaction
- `POST /chat.postEphemeral` - Send temporary messages
- `GET /users.list` - Retrieve user information
- `POST /reactions.add` - Add reactions to messages

**Authentication:** Bot token with OAuth scopes
**Rate Limits:** 50 requests per second per workspace
**Socket Mode:** Real-time events for slash commands and interactions

### Component Specifications

No UI components for this story - this is backend Slack app configuration and service setup.

### File Locations

Based on architecture source tree [Source: docs/architecture/source-tree.md]:

**Notification Service:**

- `packages/notification-service/src/services/slack.service.ts` - Slack API integration service
- `packages/notification-service/src/controllers/notification.controller.ts` - HTTP endpoints including smoke test
- `packages/notification-service/src/services/mcp-server.service.ts` - MCP server for notifications
- `packages/notification-service/src/main.ts` - Service entry point with Slack initialization

**Environment Configuration:**

- `.env.example` - Environment variables template with Slack configuration
- `README.md` - Installation and setup documentation

### Testing Requirements

Based on architecture testing strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Tests:**

- Test `SlackService` initialization with and without tokens (simulation mode)
- Test smoke test endpoint response handling
- Test Socket Mode connection logic
- Test environment variable validation

**Integration Tests:**

- Test complete Slack app installation flow
- Test smoke test endpoint with real/simulated Slack API calls
- Test channel creation and bot permissions
- Test Socket Mode connectivity end-to-end

**Test Files:**

- `packages/notification-service/test/slack.service.test.ts` - Unit tests for SlackService
- `packages/notification-service/test/notification.controller.test.ts` - Controller tests including smoke test

### Technical Constraints

Based on architecture tech stack [Source: docs/architecture/tech-stack.md]:

**Slack SDK:** @slack/bolt 3.17.0 for Slack integration
**Language:** TypeScript 5.3.3
**Framework:** NestJS 10.3.2 for service implementation
**Validation:** Joi 17.11.0 for environment variable validation
**Logging:** Winston 3.11.0 for structured logging

### Environment Variables Required

From `.env.example` [Source: .env.example]:

- `SLACK_BOT_TOKEN=xoxb-your-slack-bot-token` - Bot token for API calls
- `SLACK_SIGNING_SECRET=your-slack-signing-secret` - Request signature verification
- `SLACK_APP_TOKEN=xapp-your-slack-app-token` - App-level token for Socket Mode
- `NOTIFICATION_SERVICE_PORT=3004` - Service port configuration

### Slack App Configuration Details

**Required OAuth Scopes (Bot Token):**

- `chat:write` - Send messages to channels and users
- `chat:write.customize` - Customize message appearance
- `commands` - Add and use slash commands
- `reactions:write` - Add reactions to messages
- `users:read` - Read user information

**Optional Scopes (for future features):**

- `chat:write.public` - Send messages to public channels bot isn't in
- `channels:read` - Read public channel information

**Socket Mode Configuration:**

- Enables real-time events without webhooks
- Requires app-level token with `connections:write` scope
- Fallback to HTTP mode if Socket Mode unavailable

### Integration Points

**With Previous Stories:**

- Uses project structure from Story 1.1
- Integrates with notification-service from Story 1.5
- Uses environment configuration patterns established in Epic 1

**With Future Stories:**

- Provides foundation for slash commands (Story 2.2)
- Enables approval card system (Story 2.3)
- Supports channel management and threading (Story 2.5)

### Testing

Based on architecture test strategy [Source: docs/architecture/test-strategy-and-standards.md]:

**Unit Test Requirements:**

- Test SlackService initialization with valid/invalid tokens
- Test simulation mode activation when tokens missing
- Test smoke test endpoint success/failure responses
- Test Socket Mode configuration logic
- Mock all external Slack API calls

**Integration Test Requirements:**

- Test complete Slack app installation workflow
- Test smoke test endpoint with real Slack workspace
- Test channel creation and bot invitation process
- Test environment variable validation and error handling

**Test Coverage Target:** 80% for business logic components

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

_To be populated by Dev agent_

## QA Results

**Review Date:** 2025-08-18  
**Reviewer:** QA.mdc  
**Overall Status:** PARTIAL PASS (blocked on evidence and minor implementation gaps)

### Acceptance Criteria Validation

| AC  | Requirement                                                            | Status                  | Evidence / Notes                                                                                                                                    |
| --- | ---------------------------------------------------------------------- | ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Slack app created with required scopes and permissions                 | PASS (Pending evidence) | User confirmed completion. Provide screenshots/export from Slack app config to archive evidence.                                                    |
| 2   | Socket Mode enabled for MVP deployment                                 | PASS                    | Workspace configuration complete and `SlackService` starts Socket Mode (`app.start()`). Health exposed at `GET /api/v1/notifications/slack/health`. |
| 3   | App installation process documented and tested                         | PASS                    | README updated with Slack setup steps, env vars, channels, and smoke/health verification.                                                           |
| 4   | Required channels created (#mylo-control, #mylo-approvals, #mylo-feed) | PASS (Pending evidence) | User confirmed completion. Please attach screenshots or export logs for channel creation and bot invitations.                                       |
| 5   | Bot user configured with appropriate permissions                       | PASS                    | Verified via checker script: message, reaction, and ephemeral succeeded in all channels for user U09APV0PEGM.                                       |
| 6   | Integration testing (smoke, connectivity, env validation)              | PASS                    | Smoke endpoint verified posting to channels. Socket Mode started and health endpoint added.                                                         |

### Key Findings

- Slack Socket Mode not actually started. In `packages/notification-service/src/services/slack.service.ts`, the Bolt `App` is constructed but never started; only Web API `auth.test()` is called. This does not validate socket connectivity.
- README lacks Slack installation/configuration documentation (tokens, app-level token, scopes, channel setup, smoke test usage).
- Story references smoke endpoint as `POST /notifications/slack/test`, but the service sets a global prefix. Actual path is `POST /api/v1/notifications/slack/test` (`packages/notification-service/src/main.ts`). Update docs for accuracy.
- Env vars are present: `SLACK_BOT_TOKEN`, `SLACK_SIGNING_SECRET`, `SLACK_APP_TOKEN`, `NOTIFICATION_SERVICE_PORT` in `.env.example`.

### Recommendations (P0 = immediate)

- P0: Start Bolt `App` when `socketMode: true` to verify Socket Mode connectivity and enable future command/event handlers.
- P0: Add a Slack installation guide to README, including required scopes, app/bot installation, channel creation, and smoke-test instructions.
- P0: Update story/docs to use the correct smoke test path `/api/v1/notifications/slack/test`.
- P1: Add a basic runtime health endpoint that reports socket connection state if/when Socket Mode is active.
- P1: Provide evidence artifacts (screenshots or exported config) for app creation, bot installation, and channel setup.

### Evidence

- `packages/notification-service/src/services/slack.service.ts`
- `packages/notification-service/src/controllers/notification.controller.ts` (smoke test)
- `packages/notification-service/src/main.ts` (global prefix `api/v1` and Slack env consumption)
- `.env.example` (Slack env vars present)
